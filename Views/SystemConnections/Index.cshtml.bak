@model IEnumerable<Glory77.Models.SystemConnection>

@{
    Layout = "_VerticalLayout";
    ViewData["Title"] = "ربطيات الأنظمة";
    ViewData["Direction"] = "rtl";
}

@section styles {
    <link href="~/css/system-connections.css" rel="stylesheet" />
    
    <!-- UI Polish CSS -->
    <link href="~/css/ui-polish.css" rel="stylesheet" type="text/css">
    
    <!-- Bootstrap Select CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css" />
    
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <style>
        body[dir="rtl"] * {
            font-family: "Cairo", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        
        /* تعديل الجدول لإزالة المسافة بين الرأس والمحتوى */
        .table-bordered thead th {
            border-bottom-width: 1px;
        }
        
        .table-bordered tbody tr:first-child td {
            border-top: none;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        /* Select all checkboxes styling */
        .form-check-input:checked {
            background-color: #1ab394;
            border-color: #1ab394;
        }
        
        /* Checkbox column styling */
        .form-check {
            display: inline-block;
            margin-bottom: 0;
        }
        
        .form-check-input {
            margin-top: 0.3rem;
        }
        
        /* Alert styling for better visibility */
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        /* Dark mode alert adjustments */
        [data-bs-theme="dark"] .alert-warning {
            background-color: #664d03;
            border-color: #7d5f04;
            color: #ffecb5;
        }
        
        [data-bs-theme="dark"] .alert-danger {
            background-color: #721c24;
            border-color: #842029;
            color: #f8d7da;
        }
        
        /* DataTables info and pagination */
        .dataTables_info,
        .dataTables_paginate {
            margin-top: 15px !important;
            padding-top: 0 !important;
        }
        
        /* Calendar z-index fix */
        .flatpickr-calendar {
            z-index: 200000 !important;
        }
        
        /* Disabled top action buttons */
        .btn-outline-primary.disabled,
        .btn-outline-info.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Additional styles for the provider modal */
        .modal-content[dir="rtl"] .form-label {
            font-weight: bold;
        }
        
        .modal-content[dir="rtl"] .card-header {
            font-weight: bold;
        }
        
        .modal-content[dir="rtl"] .form-check {
            margin-bottom: 0.5rem;
        }
        
        .text-danger {
            color: #dc3545 !important;
        }
        
        .text-info {
            cursor: pointer;
        }
        
        .alert {
            border-radius: 0.375rem;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            border-color: #b8daff;
            color: #0c5460;
        }
        
        [data-bs-theme="dark"] .alert-info {
            background-color: #1c394a;
            border-color: #2a5a7a;
            color: #86c2cf;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        [data-bs-theme="dark"] .alert-warning {
            background-color: #332701;
            border-color: #5a4501;
            color: #e6d499;
        }
        
        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        [data-bs-theme="dark"] .alert-success {
            background-color: #142d1e;
            border-color: #204c31;
            color: #a2d4ad;
        }
    </style>
}

<!-- Filter toggle button -->
<div class="mb-2">
    <button id="toggleFilters" type="button" class="btn btn-primary">
        <i class="ti ti-filter-off me-1"></i><span id="toggleFiltersText">إظهار الفلترة</span>
    </button>
</div>

<!-- Filter section -->
<div class="card mb-3" id="filterSection" style="display: none;">
    <div class="card-body p-2">
        <!-- Filter fields in grid layout (side by side) -->
        <div class="row g-2 mb-2">
            <div class="col-md">
                <input type="text" class="form-control form-control-sm" placeholder="اسم المزود" id="filter-provider-name">
            </div>
            <div class="col-md">
                <input type="text" class="form-control form-control-sm" placeholder="الشبكة" id="filter-network">
            </div>
            <div class="col-md">
                <input type="text" class="form-control form-control-sm" placeholder="الموظفين" id="filter-employees">
            </div>
            <div class="col-md">
                <input type="text" class="form-control form-control-sm" placeholder="المصادر الحسابية" id="filter-account-sources">
            </div>
            <div class="col-md">
                <select class="selectpicker form-control form-control-sm" id="filter-direction" data-live-search="true" title="الجهة">
                    <option value="">الجهة</option>
                    <option value="شمال">شمال</option>
                    <option value="جنوب">جنوب</option>
                </select>
            </div>
        </div>
        
        <!-- Unified action buttons -->
        <div class="row g-2">
            <div class="col">
                <button type="button" class="btn btn-secondary btn-sm" id="resetFilters">إعادة تعيين</button>
                <button type="button" class="btn btn-primary btn-sm" id="applyFilters">بحث</button>
            </div>
        </div>
    </div>
</div>

<!-- Action buttons - Matching SIM Packages design exactly -->
<div class="mb-3">
    <div class="d-flex gap-2 flex-wrap">
        <a href="#" class="btn btn-sm btn-outline-danger" title="حذف">
            <i class="fa fa-trash"></i>
        </a>
        <!-- زر لفتح النافذة -->
        <button type="button" class="btn btn-sm btn-outline-success" title="إضافة" onclick="openAddProviderModal()">
            <i class="fa fa-plus"></i>
        </button>
        <a href="#" class="btn btn-sm btn-outline-primary" title="تعديل" id="topEditButton">
            <i class="fa fa-pencil"></i>
        </a>
        <a href="#" class="btn btn-sm btn-outline-info" title="مشاهدة" id="topViewButton">
            <i class="fa fa-eye"></i>
        </a>
        <button id="refreshBtn" class="btn btn-sm btn-outline-secondary">
            <i class="fa fa-refresh"></i>
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="d-flex align-items-center">
            <h5 class="card-title mb-0 fw-bold">@ViewData["Title"]</h5>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="providersTable" class="table table-striped table-bordered dt-responsive nowrap w-100">
                <thead>
                    <tr>
                        <th class="text-center" width="40px">
                            <div class="form-check"><input type="checkbox" class="form-check-input" id="selectAll"></div>
                        </th>
                        <th>رقم الطابور</th>
                        <th>اسم المزود</th>
                        <th>النوع</th>
                        <th>شغال؟</th>
                        <th>رصيد المزود</th>
                        <th>أقل مبلغ للتنبيه</th>
                        <th>أقل مبلغ للتوقيف</th>
                        <th>عتبة الملغيات</th>
                        <th>عتبة المعلقات</th>
                        <th>إعادة المحاولة</th>
                        <th style="width: 100px; text-align: center;">المزيد</th>
                        <th>استعلام</th>
                        <th>رصيد الحساب</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<!-- Add Connection Modal -->
<div class="modal fade" id="addConnectionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content" dir="rtl">

      <!-- الهيدر -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">ربطيات الأنظمة</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>

      <!-- النموذج -->
      <form id="addConnectionForm">
        <div class="modal-body">
          <div class="container-fluid">
            <div class="row">
              <!-- Left Column -->
              <div class="col-md-6">
                <!-- Provider -->
                <div class="mb-3">
                  <label for="providerId" class="form-label fw-bold">المزود</label>
                  <select class="form-select selectpicker" id="providerId" name="providerId" data-live-search="true">
                    <option value="">اختر المزود</option>
                    <!-- Options will be populated dynamically -->
                  </select>
                </div>

                <!-- System Name -->
                <div class="mb-3">
                  <label for="systemName" class="form-label fw-bold">اسم النظام</label>
                  <input type="text" id="systemName" name="systemName" class="form-control" placeholder="اسم النظام">
                </div>

                <!-- Connection Status -->
                <div class="mb-3">
                  <label for="connectionStatus" class="form-label fw-bold">حالة الاتصال</label>
                  <select class="form-select" id="connectionStatus" name="connectionStatus">
                    <option value="مفعل">مفعل</option>
                    <option value="غير مفعل">غير مفعل</option>
                  </select>
                </div>

                <!-- Provider Type -->
                <div class="mb-3">
                  <label for="providerType" class="form-label fw-bold">نوع المزود</label>
                  <input type="text" id="providerType" name="providerType" class="form-control" placeholder="نوع المزود">
                </div>

                <!-- Balance -->
                <div class="mb-3">
                  <label for="balance" class="form-label fw-bold">الرصيد</label>
                  <input type="number" id="balance" name="balance" class="form-control" placeholder="الرصيد">
                </div>
              </div>

              <!-- Right Column -->
              <div class="col-md-6">
                <!-- Direction -->
                <div class="mb-3">
                  <label for="direction" class="form-label fw-bold">الجهة</label>
                  <select class="form-select" id="direction" name="direction">
                    <option value="شمال">شمال</option>
                    <option value="جنوب">جنوب</option>
                  </select>
                </div>

                <!-- Response Time -->
                <div class="mb-3">
                  <label for="responseTime" class="form-label fw-bold">وقت الاستجابة</label>
                  <input type="number" id="responseTime" name="responseTime" class="form-control" placeholder="وقت الاستجابة">
                </div>

                <!-- Supported Networks -->
                <div class="mb-3">
                  <label for="supportedNetworks" class="form-label fw-bold">الشبكات المدعومة</label>
                  <input type="text" id="supportedNetworks" name="supportedNetworks" class="form-control" placeholder="الشبكات المدعومة">
                </div>

                <!-- Account Sources -->
                <div class="mb-3">
                  <label for="accountSources" class="form-label fw-bold">مصادر الحساب</label>
                  <input type="text" id="accountSources" name="accountSources" class="form-control" placeholder="مصادر الحساب">
                </div>

                <!-- Employees -->
                <div class="mb-3">
                  <label for="employees" class="form-label fw-bold">الموظفين</label>
                  <input type="text" id="employees" name="employees" class="form-control" placeholder="الموظفين">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- الفوتر -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
          <button type="submit" class="btn btn-success">حفظ</button>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- Add Provider Modal (Based on the detailed form you provided) -->
<div class="modal fade" id="addProviderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content" dir="rtl">
      <!-- الهيدر -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">إضافة مزود جديد</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>

      <!-- النموذج -->
      <form id="addProviderForm" class="frmdib">
        <div class="modal-body">
          <div class="alert alert-success" style="display:none;">
            ملاحظات مهمة في قسم ربطيات الانظمة قد لا تعرفها: <br>
            - يمكنك كتابة كلمة stop بجانب اسم المزود في نموذج الربطية، ليتم الرد مباشرة للعميل بالنص الذي تكتبه في حقل التوكن، وتلتغي العملية. <br>
            - يمكنك كتابة كلمة (يدوي) في حقل التوكن في نموذج الربطية، ليقوم النظام بتحويل العملية الى يدوي. <br>
            - يمكنك كتابة كلمة (جاهز) في حقل التوكن في نموذج الربطية، ليقوم النظام بالرد جاهز للعميل ويجهز العملية.
          </div>

          <div class="row">
            <div class="col-md-6">
              <!-- اسم المزود -->
              <div class="mb-3">
                <label class="form-label fw-bold">اسم المزود<span class="text-danger">*</span></label>
                <input type="text" name="name" class="form-control" required>
              </div>

              <!-- الرابط -->
              <div class="mb-3">
                <label class="form-label fw-bold">الرابط<span class="text-danger">*</span>
                  <span onclick="showInfo('#mfodnvis9')" class="text-info" style="cursor:pointer;">
                    <i class="fa fa-info-circle"></i> (تعليمات)
                  </span>
                </label>
                <div class="alert alert-info mt-2" id="mfodnvis9" style="display:none;">
                  ملاحظة: لتسديد شحن فوري يمن موبايل من شرائح (روبوتاتي) يمن موبايل اكتب الكلمة التالية (nmobile), للتسديد من رشايح الريال اكتب كلمة (rial), من كاك بنك (cacbank) , يمن موبايل (2) - hmobile
                </div>
                <input type="text" name="url" class="form-control" style="direction: ltr;" required>
              </div>

              <!-- رقم الايبي -->
              <div class="mb-3">
                <label class="form-label fw-bold">رقم الايبي<span class="text-danger">*</span></label>
                <input type="text" name="ip" class="form-control" style="direction: ltr;" required>
              </div>

              <!-- رقم الحساب -->
              <div class="mb-3">
                <label class="form-label fw-bold">رقم الحساب<span class="text-danger">*</span>
                  <span onclick="showInfo('#mfodnvis8')" class="text-info" style="cursor:pointer;">
                    <i class="fa fa-info-circle"></i> (تعليمات)
                  </span>
                </label>
                <div class="alert alert-warning mt-2" id="mfodnvis8" style="display:none;">
                  ملاحظة: رقم الحساب في ربط الشرائح لنظام (يمن روبوت) يتم وضع رقم الجهاز. رقم الجهاز يتم اخذه من قسم روبوتاتي-&gt; الأجهزة
                </div>
                <input type="text" name="cid" class="form-control" style="direction: ltr;" required>
              </div>

              <!--اسم المستخدم -->
              <div class="mb-3">
                <label class="form-label fw-bold">اسم المستخدم<span class="text-danger">*</span></label>
                <input type="text" name="username" class="form-control" style="direction: ltr;" required>
              </div>

              <!-- كلمة المرور -->
              <div class="mb-3">
                <label class="form-label fw-bold">كلمة المرور<span class="text-danger">*</span></label>
                <input type="text" name="pass" class="form-control" style="direction: ltr;" required>
              </div>

              <!-- التوكن -->
              <div class="mb-3">
                <label class="form-label fw-bold">التوكن<span class="text-danger">*</span>
                  <span onclick="showInfo('#mfodnvis7')" class="text-info" style="cursor:pointer;">
                    <i class="fa fa-info-circle"></i> (تعليمات)
                  </span>
                </label>
                <div class="alert alert-info mt-2" id="mfodnvis7" style="display:none;">
                  ملاحظة: بالنسبة لبوابات يمن موبايل من برمجة وتصميم يمن روبوت (الشرعبي، بن حفيظ، الغراسي) يتم اخذ التوكن من رابط البوابة قسم (الاعدادات-&gt; رمز الحساب.) هذا الحقل ضروري اذا كان الربط ليمن موبايل للبوابات المذكورة. <br>
                  ملاحظة لربط الشرائح : اذا كان ربط الشرائح يتم وضع في هذا الحقل رقم العملية في نظامك=رقم العملية في نظام الوكيل، مع وضع @ في حال كان اكثر من عملية مثل: <br>
                  112=120@114=170 <br>
                  اذا تريد ان تكون هذه الربطية يدوي اكتب في حقل التوكن (يدوي)
                  <div class="alert alert-warning mt-2">
                    <strong>ملاحظة: اذا كنت تستخدم روبوت شحن فوري وباقات يمن موبايل من (يمن روبوت) يمكنك كتابة المبلغ الذي سيتم تسديده من الوكيل هنا! بقية المبلغ من الشريحة</strong>
                  </div>
                </div>
                <input type="text" name="token" class="form-control" style="direction: ltr;" required>
              </div>

              <!-- الحالة -->
              <div class="mb-3">
                <label class="form-label fw-bold">الحالة (1- شغال. 0 - متوقف)<span class="text-danger">*</span></label>
                <input type="text" name="isrun" class="form-control" value="1" required>
              </div>

              <!-- النوع -->
              <div class="mb-3">
                <label class="form-label fw-bold">النوع<span class="text-danger">*</span>
                  <span onclick="showInfo('#mfodnvis3')" class="text-info" style="cursor:pointer;">
                    <i class="fa fa-info-circle"></i> (تعليمات)
                  </span>
                </label>
                <div class="alert alert-info mt-2" id="mfodnvis3" style="display:none;">
                  ملاحظة: يتم وضع اول كلمة من الرابط في هذا الحقل بالنسبة لانظمة المزودين يمن روبوت مثال (المزود الأميز تيليكوم حط كلمة: alamayiz ). يتم وضع كلمة robot للتسديد عبر روبوتات الشرائح. بالنسبة للمزودين التاليين حسب التوضيح: (تداول: tadawl, البيان - bayan, المترب - mutarib, الأثير - alatheer , لحظات وكيل سأفون - lahadat , برو موبايل وكيل واي - pro, رصيدي أونلاين وكيل واي - nawafid <br>
                  osys - اسس وكيل يمن موبايل ، ام دراهم وكيل يمن موبايل - omdrahim , فلوسك - floosak <br>
                  <strong>كلاء يو - YOU (شبكات اليمن، يا هلا، مجموعة الوكلاء، ملك الباقات، تعز تل, القمة، الشموخ, لؤي تيليكوم, شبكة المأمون)</strong> <br>
                  <strong>yryall - ربط مباشر لشرائح الريال عبر (يمن روبوت)</strong> 
                  <strong>ربط رسائل الواتس مباشر - yrwats</strong>
                  <strong>شرائح يو مباشر - yryou</strong>
                  <strong>شرائح سبأفون مباشر - yrsaba</strong>
                </div>
                <input type="text" name="type" class="form-control" style="direction: ltr;" required>
              </div>

              <!-- أقل مبلغ تسديد -->
              <div class="mb-3">
                <label class="form-label fw-bold">أقل مبلغ تسديد (كل الشبكات)<span class="text-danger">*</span></label>
                <input type="text" name="minamtobill" class="form-control" required>
              </div>

              <!-- أكبر مبلغ تسديد -->
              <div class="mb-3">
                <label class="form-label fw-bold">اكبر مبلغ تسديد (كل الشبكات)<span class="text-danger">*</span></label>
                <input type="text" name="maxamtobill" class="form-control" required>
              </div>
            </div>

            <div class="col-md-6">
              <!-- الموظف -->
              <div class="mb-3">
                <label class="form-label fw-bold">الموظف<span class="text-danger">*</span>
                  <span onclick="showInfo('#mfodnvis6')" class="text-info" style="cursor:pointer;">
                    <i class="fa fa-info-circle"></i> (تعليمات)
                  </span>
                </label>
                <div class="alert alert-info mt-2" id="mfodnvis6" style="display:none;">
                  ملاحظة: يجب تخصيص موظف لكل مزود. اذا كان لديك حسابين من المزود يجب تخصيص لكل حساب موظف خاص. النظام يعتمد على الموظف لفحص جاهزية العملية. إذا استخدمت نفس الموظف لاكثر من ربطية مختلفة في يوزر الربط فهذا يؤدي إلى الغاء العمليات عند فحص الجاهزية.
                </div>
                <select name="empid" class="form-select selectpicker" data-live-search="true" required>
                  <option value="">اختر الموظف</option>
                  <option value="0">بدون موظف</option>
                  <option value="123">المدير</option>
                  <option value="124">محمد عبدالرحمن يحيى الوشلي</option>
                  <option value="125">جراندكول</option>
                  <option value="126">صنعاء كاش</option>
                  <option value="127">اتصالاتي</option>
                  <option value="128">المياس الاتصالات</option>
                  <option value="129">المجد كاش</option>
                  <option value="130">توايس تيليكوم</option>
                  <option value="131">ركن الامين تيليكوم</option>
                  <option value="132">مازن الوشلي</option>
                </select>
              </div>

              <!-- المصدر الحسابي -->
              <div class="mb-3">
                <label class="form-label fw-bold">المصدر الحسابي<span class="text-danger">*</span>
                  <span onclick="showInfo('#mfodnvis5')" class="text-info" style="cursor:pointer;">
                    <i class="fa fa-info-circle"></i> (تعليمات)
                  </span>
                </label>
                <div class="alert alert-warning mt-2" id="mfodnvis5" style="display:none;">
                  ملاحظة: تخصيص حساب لكل مزود يمكنك من معرفة الارباح والخسائر بالدقة من قسم التقرير الاداري!. اذا لا يوجد حساب بعد للمزود قم بانشاء حساب خاص بالمزود من قسم الحسابات-&gt; شجرة الحسابات
                </div>
                <select name="sid" class="form-select selectpicker" data-live-search="true" required>
                  <option value="0">اختر الحساب</option>
                  <option value="318" disabled>المزودين</option>
                  <option value="319">جراند كول</option>
                  <option value="329">صنعاء كاش</option>
                  <option value="330">اتصالاتي</option>
                  <option value="331">المياس للاتصالات</option>
                  <option value="332">المجد كاش</option>
                  <option value="333">توايس تيليكوم</option>
                  <option value="334">ركن الامين تيليكوم</option>
                  <option value="320" disabled>الصناديق</option>
                  <option value="321">الكريمي</option>
                  <option value="322">الصارم للصرافه</option>
                  <option value="323">نقد</option>
                  <option value="324">اجل</option>
                  <option value="325" disabled>الايرادات</option>
                  <option value="327">فوارق السداد</option>
                  <option value="326" disabled>المصروفات</option>
                  <option value="328">شخصيه</option>
                </select>
              </div>

              <!-- جهة الربطية -->
              <div class="mb-3">
                <label class="form-label fw-bold">حدد جهة الربطية</label>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="isyoug" value="1" id="directionSouth">
                  <label class="form-check-label" for="directionSouth">جنوب</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="isyoug" value="0" id="directionNorth" checked>
                  <label class="form-check-label" for="directionNorth">شمال</label>
                </div>
              </div>

              <!-- رقم الموبايل للتنبيه -->
              <div class="mb-3">
                <label class="form-label fw-bold">رقم الموبايل للتنبيه عبر الرسائل
                  <span onclick="showInfo('#mfodnvis4')" class="text-info" style="cursor:pointer;">
                    <i class="fa fa-info-circle"></i> (تعليمات)
                  </span>
                </label>
                <div class="alert alert-info mt-2" id="mfodnvis4" style="display:none;">
                  (سيتم ارسال رسالة نصية تنبيه لرقم الموبايل عند توقيف المزود بسبب تجاوز الحد الادنى للرصيد المتبقي للتوقيف.)
                </div>
                <input type="text" name="mobile" class="form-control">
              </div>

              <!-- ارقام حسابات عملاء للتنبيه -->
              <div class="mb-3">
                <label class="form-label fw-bold">ارقام حسابات عملاء للتنبيه مثل (3333,4444,5555)</label>
                <input type="text" name="cidsnote" class="form-control">
              </div>

              <!-- بادئة الانترنت الارضي والهاتف الثابت -->
              <div class="mb-3">
                <label class="form-label fw-bold">بادئة الانترنت الارضي والهاتف الثابت مثل (01,02)
                  <span onclick="showInfo('#mfodnvis4545')" class="text-info" style="cursor:pointer;">
                    <i class="fa fa-info-circle"></i> (تعليمات)
                  </span>
                </label>
                <div class="alert alert-info mt-2" id="mfodnvis4545" style="display:none;">
                  يمكنك كتابة اكثر من بادئة، يجب ان تكتب فاصلة بعد كل بادئة (,) حتى لو كانت بادئة واحدة. مثل : <br>
                  <span style="direction: ltr;">(02,023,024,)</span>
                </div>
                <input type="text" name="pcuts" class="form-control" style="direction: ltr;">
              </div>

              <!-- ايقاف الربطيه -->
              <div class="mb-3">
                <label class="form-label fw-bold">ايقاف (1- نعم. 0 - لا)<span class="text-danger">*</span></label>
                <div class="form-text">ايقاف الربطيه عندما يكون سعر المزود اكبر من السعر في النظام</div>
                <input type="text" name="stopfprice" class="form-control" value="0" required>
              </div>
            </div>
          </div>

          <!-- الشبكات -->
          <div class="mb-3">
            <label class="form-label fw-bold">الشبكة (حدد الشبكة التي تريد تشغيلها مع المزود)<span class="text-danger">*</span></label>
            
            <!-- يمن موبايل -->
            <div class="card mb-2">
              <div class="card-header bg-primary text-white">يمن موبايل</div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="mobile" name="ns[]" id="mobile">
                      <label class="form-check-label" for="mobile">باقات يمن موبايل</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="mblnce" name="ns[]" id="mblnce">
                      <label class="form-check-label" for="mblnce">رصيد يمن موبايل</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="moblfore" name="ns[]" id="moblfore">
                      <label class="form-check-label" for="moblfore">شحن فوري يمن موبايل</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="m_b_checksolfa" name="ns[]" id="m_b_checksolfa">
                      <label class="form-check-label" for="m_b_checksolfa">فحص السلفة يمن موبايل</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="m_o_b_i_l_e_gomla" name="ns[]" id="m_o_b_i_l_e_gomla">
                      <label class="form-check-label" for="m_o_b_i_l_e_gomla">موبايل جملة</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="ri_al_m_ob_ile" name="ns[]" id="ri_al_m_ob_ile">
                      <label class="form-check-label" for="ri_al_m_ob_ile">رصيد ريال موبايل الالكتروني</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- سبافون -->
            <div class="card mb-2">
              <div class="card-header bg-success text-white">سبافون</div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="saba" name="ns[]" id="saba">
                      <label class="form-check-label" for="saba">فوري سبافون شمال</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="sbay" name="ns[]" id="sbay">
                      <label class="form-check-label" for="sbay">فوري سبافون جنوب</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="s_a_b_a_offer" name="ns[]" id="s_a_b_a_offer">
                      <label class="form-check-label" for="s_a_b_a_offer">باقات سبافون</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="s_a_b_a_units" name="ns[]" id="s_a_b_a_units">
                      <label class="form-check-label" for="s_a_b_a_units">وحدات سبافون</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="s_a_b_a_gomla" name="ns[]" id="s_a_b_a_gomla">
                      <label class="form-check-label" for="s_a_b_a_gomla">سبافون جملة</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="sbayoffer" name="ns[]" id="sbayoffer">
                      <label class="form-check-label" for="sbayoffer">باقات سبأفون جنوب</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="s_e_b_a_p_s_t" name="ns[]" id="s_e_b_a_p_s_t">
                      <label class="form-check-label" for="s_e_b_a_p_s_t">سب أفون فوترة</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="y_rqb_sa" name="ns[]" id="y_rqb_sa">
                      <label class="form-check-label" for="y_rqb_sa">استعلام سبأفون مباشر</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="sa__b_as__im" name="ns[]" id="sa__b_as__im">
                      <label class="form-check-label" for="sa__b_as__im">شرائح جديد مباشر</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- YOU-يو -->
            <div class="card mb-2">
              <div class="card-header bg-info text-white">YOU-يو</div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="mtn" name="ns[]" id="mtn">
                      <label class="form-check-label" for="mtn">فوري يو</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="_s_mr_t_nm_" name="ns[]" id="_s_mr_t_nm_">
                      <label class="form-check-label" for="_s_mr_t_nm_">يو الشاحن الذكي</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="m_t_n_offer" name="ns[]" id="m_t_n_offer">
                      <label class="form-check-label" for="m_t_n_offer">باقات يو</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="ym_yg_nt_ofr" name="ns[]" id="ym_yg_nt_ofr">
                      <label class="form-check-label" for="ym_yg_nt_ofr">باقات يو الموحدة</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="m_t_n_gomla" name="ns[]" id="m_t_n_gomla">
                      <label class="form-check-label" for="m_t_n_gomla">يو جملة </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="m_tn_post" name="ns[]" id="m_tn_post">
                      <label class="form-check-label" for="m_tn_post">يو فوترة</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="yousim" name="ns[]" id="yousim">
                      <label class="form-check-label" for="yousim">شرائح جديد مباشر</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="youresim" name="ns[]" id="youresim">
                      <label class="form-check-label" for="youresim">بدل فاقد مباشر</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- الثابت والنت + يمن فورجي -->
            <div class="card mb-2">
              <div class="card-header bg-warning text-dark">الثابت والنت + يمن فورجي</div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="line" name="ns[]" id="line">
                      <label class="form-check-label" for="line">الهاتف الثابت</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="adsl" name="ns[]" id="adsl">
                      <label class="form-check-label" for="adsl">الانترنت الارضي</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="l_i_n_e" name="ns[]" id="l_i_n_e">
                      <label class="form-check-label" for="l_i_n_e">الهاتف الثابت فئات</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="a_d_s_l" name="ns[]" id="a_d_s_l">
                      <label class="form-check-label" for="a_d_s_l">الانترنت الارضي فئات</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="ypm_4gr" name="ns[]" id="ypm_4gr">
                      <label class="form-check-label" for="ypm_4gr">يمن فورجي</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- اخرى -->
            <div class="card mb-2">
              <div class="card-header bg-secondary text-white">اخرى</div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="sim" name="ns[]" id="sim">
                      <label class="form-check-label" for="sim">الشرائح |الخدمات اليدوي</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="sendmoney" name="ns[]" id="sendmoney">
                      <label class="form-check-label" for="sendmoney">ارسال حوالة</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="rcvmoney" name="ns[]" id="rcvmoney">
                      <label class="form-check-label" for="rcvmoney">استلام حوالة</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="adenet" name="ns[]" id="adenet">
                      <label class="form-check-label" for="adenet">عدن نت</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="argam" name="ns[]" id="argam">
                      <label class="form-check-label" for="argam">بنك الكروت والارقام</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="elc_tpad" name="ns[]" id="elc_tpad">
                      <label class="form-check-label" for="elc_tpad">سداد الكهرباء</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="wa_trpad" name="ns[]" id="wa_trpad">
                      <label class="form-check-label" for="wa_trpad">سداد الماء</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="pstwfyi" name="ns[]" id="pstwfyi">
                      <label class="form-check-label" for="pstwfyi">يمن واي فاي</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="yrwats" name="ns[]" id="yrwats">
                      <label class="form-check-label" for="yrwats">رسائل الواتس</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- الفوتر -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
          <button type="submit" class="btn btn-success">حفظ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Anti-forgery token for DataTables Ajax requests -->
@Html.AntiForgeryToken()

@section scripts {
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Toastr (for additional toast support) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <!-- Date Range Picker JS -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    
    <!-- Bootstrap Select JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    
    <!-- System Connections Custom JS -->
    <script src="~/js/system-connections.js"></script>
    
    <script>
    $(document).ready(function () {
        // Set Bootstrap version for selectpicker
        $.fn.selectpicker.Constructor.BootstrapVersion = '5';
        
        $('#providersTable').DataTable({
            processing: true,        // يظهر رسالة "جاري التحميل"
            serverSide: true,        // تفعيل التحميل من السيرفر
            ajax: {
                url: '@Url.Action("GetProvidersData", "SystemConnections")',
                type: 'POST',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                }
            },
            pageLength: 10,          // عدد الصفوف في الصفحة
            language: { 
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json' 
            },
            columns: [
                { 
                    data: null,
                    render: function(data, type, row) {
                        return '<div class="form-check"><input type="checkbox" class="form-check-input provider-checkbox" value="' + row.QueueNumber + '"></div>';
                    }
                },
                { data: 'QueueNumber' },
                { data: 'ProviderName' },
                { data: 'Type' },
                { data: 'IsActive' },
                { data: 'Balance' },
                { data: 'AlertLimit' },
                { data: 'SuspendLimit' },
                { data: 'CancelThreshold' },
                { data: 'PendingThreshold' },
                { data: 'Retry' },
                { 
                    data: 'More',
                    render: function(data, type, row) {
                        return '<div class="dropdown">' +
                            '<button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">' +
                            'للمزيد' +
                            '</button>' +
                            '<ul class="dropdown-menu dropdown-menu-end">' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'run\')"><i class="fa fa-play me-1"></i> تشغيل</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'stop\')"><i class="fa fa-stop me-1"></i> إيقاف</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'balance\')"><i class="fa fa-money me-1"></i> رصيد</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'credit\')"><i class="fa fa-credit-card me-1"></i> رصيد إضافي</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'pending\')"><i class="fa fa-clock-o me-1"></i> معلق</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'operations\')"><i class="fa fa-tasks me-1"></i> عمليات</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'daily\')"><i class="fa fa-calendar me-1"></i> يومي</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'notifications\')"><i class="fa fa-bell me-1"></i> إشعارات</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'insurance\')"><i class="fa fa-shield me-1"></i> تأمين</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'account-balance\')"><i class="fa fa-bank me-1"></i> رصيد الحساب</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'alerts\')"><i class="fa fa-exclamation-triangle me-1"></i> تنبيه</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'suspension\')"><i class="fa fa-pause me-1"></i> إيقاف</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'networks\')"><i class="fa fa-sitemap me-1"></i> شبكات</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'match\')"><i class="fa fa-exchange me-1"></i> مطابقة</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'notes\')"><i class="fa fa-sticky-note me-1"></i> ملاحظات</a></li>' +
                            '<li><a class="dropdown-item" href="#" onclick="handleProviderAction(' + row.QueueNumber + ', \'reports\')"><i class="fa fa-file-text me-1"></i> تقارير</a></li>' +
                            '</ul>' +
                            '</div>';
                    }
                },
                { 
                    data: 'Inquiry',
                    render: function(data, type, row) {
                        return '<button class="btn btn-sm btn-outline-info" onclick="handleProviderAction(' + row.QueueNumber + ', \'balance\')">استعلام</button>';
                    }
                },
                { data: 'AccountBalance' }
            ]
        });
        
        // Initialize bootstrap select
        $('.selectpicker').selectpicker();
        
        // Handle edit button
        $('#topEditButton').click(function(e) {
            e.preventDefault();
            var checkedBoxes = $('.provider-checkbox:checked');
            if (checkedBoxes.length === 0) {
                showToast('الرجاء تحديد عنصر واحد على الأقل للتعديل', 'warning');
                return;
            }
            
            // For now, we'll just edit the first selected item
            var firstChecked = checkedBoxes.first();
            var id = firstChecked.val();
            
            // Redirect to edit page
            window.location.href = '@Url.Action("Edit", "SystemConnections")/' + id;
        });
        
        // Handle view button
        $('#topViewButton').click(function(e) {
            e.preventDefault();
            var checkedBoxes = $('.provider-checkbox:checked');
            if (checkedBoxes.length === 0) {
                showToast('الرجاء تحديد عنصر واحد على الأقل للمشاهدة', 'warning');
                return;
            }
            
            // For now, we'll just view the first selected item
            var firstChecked = checkedBoxes.first();
            var id = firstChecked.val();
            
            // Redirect to details page
            window.location.href = '@Url.Action("Details", "SystemConnections")/' + id;
        });
        
        // Handle form submission
        $('#addConnectionForm').on('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            var formData = {
                providerId: $('#providerId').val(),
                systemName: $('#systemName').val(),
                connectionStatus: $('#connectionStatus').val(),
                providerType: $('#providerType').val(),
                balance: $('#balance').val(),
                direction: $('#direction').val(),
                responseTime: $('#responseTime').val(),
                supportedNetworks: $('#supportedNetworks').val(),
                accountSources: $('#accountSources').val(),
                employees: $('#employees').val()
            };
            
            // In a real application, you would submit the form data via AJAX
            showToast('تم إضافة الربطية بنجاح!', 'success');
            $('#addConnectionModal').modal('hide');
            this.reset();
            $('.selectpicker').selectpicker('refresh');
            
            // Reload the DataTable
            $('#providersTable').DataTable().ajax.reload();
        });
        
        // Handle add provider form submission
        $('#addProviderForm').on('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            var formData = $(this).serialize();
            
            // In a real application, you would submit the form data via AJAX
            showToast('تم إضافة المزود بنجاح!', 'success');
            $('#addProviderModal').modal('hide');
            this.reset();
            $('.selectpicker').selectpicker('refresh');
            
            // Reload the DataTable
            $('#providersTable').DataTable().ajax.reload();
        });
    });
    
    // Function to show/hide info alerts
    function showInfo(id) {
        $(id).toggle();
    }
    
    // Function to open the add provider modal
    function openAddProviderModal() {
        $('#addProviderModal').modal('show');
    }
    </script>
}